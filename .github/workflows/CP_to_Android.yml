name: Create android-app Issue

on:
  issues:
    types: [opened, labeled]

concurrency:
  group: cp-android-child-${{ github.repository }}-${{ github.event.issue.number }}
  cancel-in-progress: false

jobs:
  create_android_app_issue:
    runs-on: ubuntu-latest

    steps:
      - name: Create issue in dakboard/android-app (only if Android-App, no duplicates)
        id: create_android_app
        env:
          CP_NUMBER: ${{ github.event.issue.number }}
          CP_TITLE: ${{ github.event.issue.title }}
          CP_BODY: ${{ github.event.issue.body }}
          CP_URL: ${{ github.event.issue.html_url }}
        run: |
          set -euo pipefail

          # Gate: must have Android-App label (exact match)
          HAS_ANDROID_APP=$(jq -r '.issue.labels[].name' "$GITHUB_EVENT_PATH" | grep -Fx "Android-App" || true)
          if [ -z "$HAS_ANDROID_APP" ]; then
            echo "Issue #$CP_NUMBER does not have Android-App label. Skipping."
            exit 0
          fi

          # Hard dedupe: if marker label is present in THIS event payload, skip
          ALREADY_CREATED=$(jq -r '.issue.labels[].name' "$GITHUB_EVENT_PATH" | grep -Fx "android-app-child-created" || true)
          if [ -n "$ALREADY_CREATED" ]; then
            echo "Marker label android-app-child-created already present. Skipping."
            exit 0
          fi

          echo "Issue #$CP_NUMBER has Android-App and no marker (payload). Checking live labels on CP issue..."

          # Re-check live labels from CP issue (handles race if another run already added marker)
          CP_LABELS_STATUS=$(curl -sS -o cp_issue.json -w "%{http_code}" \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/dakboard/Cloud-Platform/issues/$CP_NUMBER")

          if [ "$CP_LABELS_STATUS" -lt 200 ] || [ "$CP_LABELS_STATUS" -ge 300 ]; then
            echo "Failed to fetch CP issue live state (status $CP_LABELS_STATUS)"
            cat cp_issue.json
            exit 1
          fi

          LIVE_MARKER=$(jq -r '.labels[].name' cp_issue.json | grep -Fx "android-app-child-created" || true)
          if [ -n "$LIVE_MARKER" ]; then
            echo "Marker label already present on CP issue (live). Skipping."
            exit 0
          fi

          echo "No marker on CP issue (live). Checking for existing child (best-effort search)..."

          # Best-effort dedupe via search (can lag; marker label is the real guard)
          SEARCH_QUERY="repo:dakboard/android-app is:issue in:title \"CP#${CP_NUMBER} —\""
          SEARCH_URL="https://api.github.com/search/issues?q=$(python -c "import urllib.parse; print(urllib.parse.quote('''$SEARCH_QUERY'''))")"

          SEARCH_RESP=$(curl -sS \
            -H "Authorization: token ${{ secrets.REPO_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            "$SEARCH_URL")

          TOTAL=$(echo "$SEARCH_RESP" | jq -r '.total_count // 0')
          if [ "$TOTAL" -gt 0 ]; then
            EXISTING_URL=$(echo "$SEARCH_RESP" | jq -r '.items[0].html_url // ""')
            echo "Child already exists (search found): $EXISTING_URL"

            # Add marker label so we don't keep checking/creating
            curl -sS -X POST \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github+json" \
              "https://api.github.com/repos/dakboard/Cloud-Platform/issues/$CP_NUMBER/labels" \
              -d "$(jq -n --arg l "android-app-child-created" '{labels: [$l]}')" >/dev/null

            exit 0
          fi

          echo "No existing child found. Creating android-app issue."

          TITLE="CP#${CP_NUMBER} — ${CP_TITLE}"
          BODY=$(printf "CP-ISSUE: %s\nCloud-Platform issue: %s\n\nCustomer reported:\n\n%s\n" "$CP_NUMBER" "$CP_URL" "$CP_BODY")

          JSON_PAYLOAD=$(jq -n --arg title "$TITLE" --arg body "$BODY" '{title: $title, body: $body}')

          HTTP_STATUS=$(curl -sS -o response.json -w "%{http_code}" \
            -X POST \
            -H "Authorization: token ${{ secrets.REPO_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/dakboard/android-app/issues \
            -d "$JSON_PAYLOAD")

          echo "HTTP_STATUS=$HTTP_STATUS"
          echo "API response:"
          cat response.json

          if [ "$HTTP_STATUS" -ne 201 ]; then
            echo "Failed to create android-app issue (status $HTTP_STATUS)"
            exit 1
          fi

          ANDROID_NUMBER=$(jq -r '.number' response.json)
          echo "android_app_number=$ANDROID_NUMBER" >> "$GITHUB_OUTPUT"

          # Add marker label to CP issue so we NEVER create duplicates on future events
          curl -sS -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/dakboard/Cloud-Platform/issues/$CP_NUMBER/labels" \
            -d "$(jq -n --arg l "android-app-child-created" '{labels: [$l]}')" >/dev/null

          echo "Added marker label android-app-child-created to CP issue #$CP_NUMBER"

