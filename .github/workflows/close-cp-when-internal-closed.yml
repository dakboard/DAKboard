name: Close Cloud-Platform issue when Internal closes

on:
  issues:
    types: [closed]

jobs:
  close_cp_issue:
    runs-on: ubuntu-latest

    steps:
      - name: Determine CP issue number (from body, fallback to title)
        id: extract
        run: |
          set -euo pipefail

          TITLE=$(jq -r '.issue.title' "$GITHUB_EVENT_PATH")
          BODY=$(jq -r '.issue.body // ""' "$GITHUB_EVENT_PATH")

          echo "Internal issue title: $TITLE"

          # Preferred: stable marker in the body, e.g. "CP-ISSUE: 2503"
          CP_NUMBER=$(printf "%s\n" "$BODY" | sed -n 's/^CP-ISSUE:[[:space:]]*\([0-9]\+\).*$/\1/p' | head -n 1)

          # Fallback: title prefix "CP#2503 â€” ..."
          if [ -z "$CP_NUMBER" ]; then
            CP_NUMBER=$(echo "$TITLE" | sed -n 's/^CP#\([0-9]\+\).*/\1/p')
          fi

          if [ -z "$CP_NUMBER" ]; then
            echo "Could not determine CP issue number. Skipping."
            echo "cp_number=" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "Found CP issue number: $CP_NUMBER"
          echo "cp_number=$CP_NUMBER" >> "$GITHUB_OUTPUT"

      - name: Close Cloud-Platform issue
        if: steps.extract.outputs.cp_number != ''
        run: |
          set -euo pipefail

          CP_NUMBER=${{ steps.extract.outputs.cp_number }}
          echo "Closing Cloud-Platform issue #$CP_NUMBER"

          HTTP_STATUS=$(curl -sS -o cp_close.json -w "%{http_code}" \
            -X PATCH \
            -H "Authorization: token ${{ secrets.REPO_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/dakboard/Cloud-Platform/issues/$CP_NUMBER" \
            -d '{"state":"closed"}')

          echo "Close HTTP status: $HTTP_STATUS"
          cat cp_close.json

          if [ "$HTTP_STATUS" -lt 200 ] || [ "$HTTP_STATUS" -ge 300 ]; then
            echo "Failed to close Cloud-Platform issue (status $HTTP_STATUS)"
            exit 1
          fi
